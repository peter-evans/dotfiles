#!/usr/bin/env bash
#
# Configures VS Code settings for prompt files locations in Codespaces

set -euo pipefail

script_path="${BASH_SOURCE[0]}"
# Resolve symlinks to get the actual script location
while [ -L "$script_path" ]; do
    script_dir="$(cd -P "$(dirname "$script_path")" && pwd)"
    script_path="$(readlink "$script_path")"
    [[ $script_path != /* ]] && script_path="$script_dir/$script_path"
done
dotfiles_dir="$(cd -P "$(dirname "$script_path")/.." && pwd)"

vscode_settings_dir="$HOME/.vscode-remote/data/Machine"
settings_file="$vscode_settings_dir/settings.json"

mkdir -p "$vscode_settings_dir"

echo -n "Configuring VS Code settings for prompt files ..."
if [ -f "$settings_file" ]; then
    # Merge with existing settings
    jq -s '.[0] * .[1]' "$settings_file" <(echo "{
        \"chat.promptFilesLocations\": {
            \"$dotfiles_dir/prompts\": true
        }
    }") > "$settings_file.tmp"
    mv "$settings_file.tmp" "$settings_file"
else
    cat > "$settings_file" << EOF
{
    "chat.promptFilesLocations": {
        "$dotfiles_dir/prompts": true
    }
}
EOF
fi
echo "done"
